# 输入网址到网页显示过程    
[原文](https://blog.csdn.net/qq_36638788/article/details/124454970?spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-124454970-blog-124649122.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-124454970-blog-124649122.pc_relevant_default&utm_relevant_index=2)  

小林coding：<https://xiaolincoding.com/>   
大致流程如下   

![url](./images/url.png)   

## HTTP  

>浏览器首先解析URL    

[URL组成](../other/other.md)    

对 URL 进行解析之后，浏览器确定了 Web 服务器和文件名，接下来就根据这些信息来生成 HTTP 请求消息。   

## DNS   

浏览器解析 URL 并生成 HTTP 消息后，需要委托操作系统将消息发送给 Web 服务器。

在发送之前，需要查询服务器域名对应的 IP 地址      

>DNS服务器保存了web服务器域名与IP地址之间的一一对应关系   


[DNS域名解析](../IP/IP相关协议.md)     


## 协议栈   

通过 DNS 获取到 IP 后，就可以把 HTTP 的传输工作交给操作系统中的协议栈。     

协议栈上面的部分会向下面部分委托工作，下面的部分收到委托并执行     


应用程序调用Socket库，TCP,UDP协议接收应用层委托执行收发数据操作    


协议栈的下面一半是用 IP 协议控制网络包收发操作，在互联网上传数据时，数据会被切分成一块块的网络包，而将网络包发送给对方的操作就是由 IP 负责的     

[IP相关协议](../IP/IP相关协议.md)   

IP 下面的网卡驱动程序负责控制网卡硬件，而最下面的网卡则负责完成实际的收发操作，对网线中的信号执行发送和接收操作       


![stack](./images/stack.png)   


## TCP  

[TCP建立连接](../TCP/TCP基础知识.md)     

TCP 协议里面会有两个端口，一个是浏览器监听的端口（通常是随机生成的），一个是 Web 服务器监听的端口（HTTP 默认端口号是 80， HTTPS 默认端口号是 443）。   


双方建立连接后，TCP数据部分存放HTTP头部和数据，组装好后交给网络层处理     


## IP     

>TCP模块在执行连接、收发、断开等各阶段操作时，都需要委托IP模块将数据封装成网络包发送给通信对象。   

IP数据包格式：   

![IP](./images/IP.png)    

>存在多个网卡时,需要根据路由表规则，来判断哪一个网卡作为源地址 IP。将web服务器目标地址与子网掩码进行&运算，得到结果与路由表对比     



## MAC   

>生成IP报文后，需要在IP头部加上MAC头部   
>在 MAC 包头里需要发送方 MAC 地址和接收方目标 MAC 地址，用于两点之间的传输。     

![MAC](./images/MAC.png)   

发送方的 MAC 地址是在网卡生产时写入到 ROM 里的，只要将这个值读取出来写入到 MAC 头部就可以了    

接收方MAC地址：发送方先在路由表中找到接收方IP地址，在通过ARP协议(发包时先查询 ARP 缓存)获取接收方MAC地址     

[ARP协议](../IP/IP相关协议.md)    

一般在 TCP/IP 通信里，MAC 包头的协议类型只使用：   

0800 ： IP 协议   
0806 ： ARP 协议    


## 出口-网卡  

网卡负责将网络包的数字信息转换为电信号，电信号才能在网线上传输   

控制网卡还需要靠网卡驱动程序。   

网卡驱动获取网络包之后，会将其复制到**网卡内的缓存区**中，接着会在其开头加上报头和起始帧分界符，在末尾加上用于检测错误的帧校验序列。    

![gate](./images/gateway.png)    


- 起始帧分界符是一个用来表示包起始位置的标记  
- 末尾的 FCS（帧校验序列）用来检查包传输过程是否有损坏    

最后网卡会将包转为电信号，通过网线发送出去。   


## 交换机   

>交换机的设计是将网络包原样转发到目的地。交换机工作在MAC层，也称为二层网络设备。  

交换机接收到电信号后将其转换为数字信号，然后通过末尾的FCS校验，如果没有错误就将其放到缓冲区    

网卡本身有MAC地址，通过核对收到的包的接收方MAC地址判断是不是发给自己的，不是则丢掉   

交换机端口不具有MAC地址，不核对接收方的MAC地址，直接接收所有的包并存到缓冲区   

交换机根据 MAC 地址表查找 MAC 地址，然后将信号发送到相应的端口。     

交换机的 MAC 地址表主要包含两个信息：  
1. 一个是设备的 MAC 地址，  
2. 另一个是该设备连接在交换机的哪个端口上    

当找不到指定的MAC地址时，可能是因为该设备还没有向该交换机发送过包，或者这个设备一段时间没有工作导致地址从地址表中删除    

此时交换机无法判断应该把包转发到哪个端口，只能将包转发到除了源端口之外的所有端口上，无论该设备连接在哪个端口上都能收到这个包，只有相应接收者才接收，其他设备会忽略      


## 路由器  

网络包经过交换机之后，现在到达了路由器，并在此被转发到下一个路由器或目标设备。

这一步转发的工作原理和交换机类似，也是通过查表判断包转发的目标。     

>与交换机区别    
- 路由器是基于 IP 设计的，俗称三层网络设备，路由器的各个端口都具有 MAC 地址和 IP 地址；     
- 交换机是基于以太网设计的，俗称二层网络设备，交换机的端口不具有 MAC 地址。     


路由器的端口具有 MAC 地址，因此它就能够成为以太网的发送方和接收方；同时还具有 IP 地址，从这个意义上来说，它和计算机的网卡是一样的。   

>接收包   

电信号到达网线接口部分，路由器中的模块会将电信号转成数字信号，然后通过包末尾的 FCS 进行错误校验。 

没问题则检查 MAC 头部中的接收方 MAC 地址，看看是不是发给自己的包，如果是就放到接收缓冲区中，否则丢弃这个包   

>发送包  

去掉MAC头部,查询路由表确定输出端口->获取接收方MAC地址发送...


>在网络包传输的过程中，源 IP 和目标 IP 始终是不会变的，一直变化的是 MAC 地址，因为需要 MAC 地址在以太网内进行两个设备之间的包传输。     


## 服务端   

数据包抵达服务器后，服务器依次检验MAC头部，IP头部，TCP头部

查看是否和服务器自己的 MAC 地址符合，符合就将包收起来。    

查看IP 地址是否符合符合，根据 IP 头中协议项，知道自己上层是 TCP 协议。    

于是，扒开 TCP 的头，里面有序列号，需要看一看这个序列包是不是我想要的，如果是就放入缓存中然后返回一个 ACK，如果不是就丢弃。TCP头部里面还有端口号， HTTP 的服务器正在监听这个端口号。      

于是，服务器自然就知道是 HTTP 进程想要这个包，于是就将包发给 HTTP 进程。    

服务器的 HTTP 进程看到，原来这个请求是要访问一个页面，于是就把这个网页封装在 HTTP 响应报文里。   

HTTP 响应报文也需要穿上 TCP、IP、MAC 头部，不过这次是源地址是服务器 IP 地址，目的地址是客户端 IP 地址。    

包装好后，从网卡出去，交由交换机转发到出城的路由器，路由器就把响应数据包发到了下一个路由器，直到客户端的路由器    

客户端把收到的数据包的皮扒剩 HTTP 响应报文后，交给浏览器去渲染页面   

最后，客户端要离开了，向服务器发起了 TCP 四次挥手，至此双方的连接就断开了       






