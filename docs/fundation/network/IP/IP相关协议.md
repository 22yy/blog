# IP协议相关

## DNS  

上网的时候，通常使用的方式是域名不是IP地址，域名方便人记忆  

DNS域名解析可以将域名网址自动转换为IP地址     

DNS域名都是用句点来分隔的，越靠右的位置层级越高     

域名的层级关系类似一个树状结构：

- 根 DNS 服务器
- 顶级域 DNS 服务器（com）
- 权威 DNS 服务器（server.com）

### 域名解析流程    
>类似问路过程，只指路不带路  

1. 浏览器首先看自己的缓存里有没有 ，没有就像操作系统的缓存要，再没有就检查本机域名解析文件hosts，还没有就会进行DNS服务查询    

2. 客户端首先发送一个DNS请求给本地DNS服务器（客户端的TCP/IP设置中填写的DNS服务器地址）   

3. 本地域名服务器收到请求后如果能在缓存中找到则直接返回IP地址，没有就会去问它的根域名服务器（最高层次，不直接用于域名解析），能指明道路  

4. 根DNS收到本地DNS请求后，会将相应的顶级域名服务器地址发给本地服务器，如www.server.com,将.com顶级域名服务器地址发送  
   
5. 本地DNS收到后，发起请求询问顶级域名服务器    

6. 顶级域名服务器将相应的权威DNS服务器地址发给本地服务器  

7. 本地服务器再询问权威DNS服务器相应的IP地址  

8. 权威DNS服务器查询后将对应IP地址告诉本地DNS  

9.  本地DNS再将IP地址返回客户端，客户端和目标建立连接  

## ARP
由于主机的路由表中可以找到下⼀跳的 IP 地址，所以可以通过 ARP 协议，求得下⼀跳的 MAC 地址。  

ARP借助ARP请求与ARP响应确定MAC地址  
  - 主机通过广播发送ARP请求，包中包含想知道的MAC地址的主机IP地址
  - 同一链路中的设备收到后会拆开包，若里面的IP地址和自己的一样，就会通过ARP响应将自己的MAC地址发送给相应主机
  - 操作系统会把第一次通过ARP获得的MAC地址缓存，并为其设置有效时间  


## RARP  

和ARP协议相反，根据MAC地址求IP地址  

通常需要架设一台RARP服务器，在这个服务器上注册设备IP地址和MAC地址，再将设备接入网络  

- 设备发送一条请求信息，将自己的MAC地址放入其中
- RARP服务器收到后将对应的IP地址给这个设备
- 设备根据收到的信息设置自己的IP信息  


## DHCP  

用来动态获取IP地址  

DHCP 客户端进程监听的 68 端口号，DHCP 服务端进程监听 67 端口号

1. 客户端使用UDP广播通信发起DHCP发现报文(DHCP DISCOVER),广播目的地址255.255.255.255（端口号67），源IP地址0.0.0.0（端口号68），DHCP客户端将该IP数据包传给链路层，链路层将帧广播到所有网络设备
2. DHCP服务端收到报文后，用DHCP提供报文（DHCP OFFER）向客户端做出回应，仍然用IP广播地址255.255.255.255，报文中携带服务器提供可供租约的IP地址，子网掩码，默认网关，DNS服务器以及IP地址租用期
3. 客户端收到一个或多个服务器提供的DHCP报文后，从中选择一个，发送DHCP请求报文(DHCP REQUEST)，回显配置的参数
4. 最后，服务器发送DHCP ACK报文进行响应，应答所需要的参数

客户端租约的IP地址快到期后，会像服务器发送DHCP请求报文  
- 如果服务器同意继续租用，最用DHCP ACK报文进行响应
- 不同意，则用<b>DHCP NACK</b>进行响应   

由于DHCP用的全都是UDP广播通信，当DHCP和客户端不在同一个局域网中时，路由器不会转发广播包，通信由<b>DHCP中继代理</b>   

当DHCP服务器与客户端不在同一个局域网中时   
  - DHCP客户端向DHCP中继代理发送DHCP请求包，中继代理收到后以<b>单播</b>的形式发给DHCP服务器
  -  DHCP服务器收到请求后再向DHCP中继代理应答，再由中继代理将此包广播给DHCP客户端

<style type="text/css" rel="stylesheet">
b{ 
    color: #5ab1f9; 
    }
</style>  


## NAT  

网络地址转换NAT，缓解IPv4地址耗尽的问题   

同一个公司，家庭，教室内的主机对外通信时，把私有IP地址转换成公有IP   

由于绝大多数的网络应用都是使用传输层协议 TCP 或 UDP 来传输数据的。

因此，可以把 IP 地址 + 端口号一起进行转换。  

这样，就用一个全球 IP 地址就可以了，这种转换技术就叫<b>网络地址与端口转换 NAPT</b>   


## ICMP  

ICMP 全称是 Internet Control Message Protocol，也就是<b>互联网控制报文协议</b>   

ICPM主要功能 ：
  - 确认IP包能否成功发送到目的地址
  - 报告IP包在发送过程中被废弃的原因  


ICMP通知消息会通过IP进行发送，大致分为两大类
 - 查询报文类型
 - 差错报文类型

