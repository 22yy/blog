# HTTP2

>HTTP/2 协议是基于 HTTPS 的，所以 HTTP/2 的安全性也是有保障的。

## HTTP/2 相⽐ HTTP/1.1 性能上的改进

### 头部压缩  

   - 同时发送多个头部相同或相似的请求，协议会消除重复的部分
   - 用的是HPACK 算法：在客户端和服务器同时维护⼀张头信息表，所有字段都会存⼊这个表，⽣成⼀个索引号，以后就不发送同样字段了，只发送索引号，提⾼速度。    


HTTP/2 没使用常见的 gzip 压缩方式来压缩头部，而是开发了 HPACK 算法，HPACK 算法主要包含三个组成部分：

- 静态字典；   
- 动态字典；  
- Huffman 编码（压缩算法）；  

客户端和服务器两端都会建立和维护「字典」，用长度较小的索引号表示重复的字符串，再用 Huffman 编码压缩数据，可达到 50%~90% 的高压缩率。    



### ⼆进制格式   

   - 不采用HTTP/1.1 ⾥的纯⽂本形式的报⽂，全⾯采⽤了⼆进制格式，头信息和数据体都是⼆进制，统称为帧（frame）：头信息帧和数据帧。  


### 多路复用

   - 一个连接中并发多个请求或回应，不用按顺序一一对应
   - 不需要排队等待，也就不会再出现「队头阻塞」问题，降低了延迟   
   - 当一个请求非常耗时，先回应已处理好的部分，回应其他请求后再回应该请求剩下的部分  

### 数据流

   - 每个请求或回应的所有数据包，称为⼀个数据流（ Stream ），每个数据流都有编号
   - 客户端可以指定数据流的优先级。优先级⾼服务器就先响应。  


通过 Stream 这个设计，<b>多个 Stream 复用一条 TCP 连接</b> ，达到并发的效果，解决了 HTTP/1.1 队头阻塞的问题，提高了 HTTP 传输的吞吐量。   

1. 1 个 TCP 连接包含一个或者多个 Stream，Stream 是 HTTP/2 并发的关键技术；   
2. Stream 里可以包含 1 个或多个 Message，Message 对应 HTTP/1 中的请求或响应，由 HTTP 头部和包体构成；    
3. Message 里包含一条或者多个 Frame，Frame 是 HTTP/2 最小单位，以二进制压缩格式存放 HTTP/1 中的内容（头部和包体）    
4. HTTP 消息可以由多个 Frame 构成， 一个 Frame 可以由多个 TCP 报文构成。  


### 服务器推送  

   - 服务不再是被动地响应，也可以主动向客户端发送消息。
   - 浏览器请求HTML时，提前吧可能会用到的JS，CSS等推送给客户端    


客户端发起的请求，必须使用的是<b>奇数号 Stream</b>，服务器主动的推送，使用的是<b>偶数号 Stream</b>。服务器在推送资源时，会通过 PUSH_PROMISE 帧传输 HTTP 头部，并通过帧中的 Promised Stream ID 字段告知客户端，接下来会在哪个偶数号 Stream 中发送包体。      


## 缺陷

HTTP/2 多个请求复⽤⼀个TCP连接，⼀旦发⽣丢包，触发TCP重传机制，就会阻塞住所有的 HTTP 请求。   

HTTP/2 是基于 TCP 协议来传输数据的，TCP 是字节流协议，TCP 层必须保证收到的字节数据是完整且连续的，这样内核才会将缓冲区里的数据返回给 HTTP 应用，那么当「前 1 个字节数据」没有到达时，后收到的字节数据只能存放在内核缓冲区里，只有等到这 1 个字节数据到达时，HTTP/2 应用层才能从内核中拿到数据，这就是 HTTP/2 `队头阻塞`问题。      

