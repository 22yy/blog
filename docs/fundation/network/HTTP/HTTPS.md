# HTTPS

## HTTP与HTTPS

1. 概念
   >HTTPS是以安全为目标的HTTP通道，简单讲是HTTP的安全版，即HTTP下加入SSL层，HTTPS的安全基础是SSL，因此加密的详细内容就需要SSL。

2. HTTP和HTTPS区别
    - http是超文本传输协议，信息是明文传输，https则是具有安全性的SSL加密传输协议
    - http的默认端口是80，https的默认端口是443
    - https比http多了加密传输，网络身份认证的功能
    - https协议需要向 CA（证书权威机构）申请数字证书，来保证服务器的身份是可信的。  

## HTTPS解决了HTTP哪些问题
1. 混合加密
    HTTPS 采⽤的是对称加密和⾮对称加密结合的「混合加密」⽅式，防止用户信息被获取
      - 在通信建⽴前采⽤⾮对称加密的⽅式交换「会话秘钥」，后续就不再使⽤⾮对称加密。
      - 在通信过程中全部使⽤对称加密的「会话秘钥」的⽅式加密明⽂数据

2. 摘要算法  
    为数据⽣成独⼀⽆⼆的「指纹」，⽤于校验数据的完整性，解决了篡改的⻛险。

3. 数字证书    
     将服务器公钥放在数字证书（由数字证书认证机构颁发）中，只要证书是可信的，公钥就是可信的。  
     通过数字证书的⽅式保证服务器公钥的身份，解决冒充的⻛险。  


## HTTPS如何建立连接
1. 三次握手
2. 建立SSL/TLS连接，基本流程：
  - 客户端向服务器索要并验证服务器的公钥。
  - 双⽅协商⽣产「会话秘钥」。
  - 双⽅采⽤「会话秘钥」进⾏加密通信。

详细过程：
   1. ClientHello  
   客户端发起加密通信的请求，并生成一个随机数发送给服务器

   2. SeverHello  
   服务器收到请求后，会将网站的证书信息（包含公钥）传送一份给客户端，同时生成第二个随机数发送
   
   3. 客户端回应  
    客户端收到后会用浏览器或者操作系统的CA证书验证证书合法性，并提取出公钥，然后生成第三个随机数发送
    此时客户端发送的信息是用公钥加密的，只有对应的服务器有私钥解密

   4. 服务器回应   
     服务器收到后用私钥解密，将三个随机数用算法生成`会话密钥`，客户端也一样，生成的密钥是一样的  


⾄此，整个 SSL/TLS 的握⼿阶段全部结束。接下来，客户端与服务器进⼊加密通信，就完全是使⽤普通的 HTTP
协议，只不过⽤「会话秘钥」加密内容。   

>SSL连接总结： 采用非对称加密（公钥和私钥）来商量会话密钥（对称加密）是多少，商量完成后就用这个会话密钥作为对称加密的密钥来进行通信

采⽤「混合加密」的⽅式的原因：  
 - 对称加密只使⽤⼀个密钥，运算速度快，密钥必须保密，⽆法做到安全的密钥交换。
 - ⾮对称加密使⽤两个密钥：公钥和私钥，公钥可以任意分发⽽私钥保密，解决了密钥交换问题但速度慢  



## HTTPS如何优化

  性能消耗的两个环节：   
   - TLS 协议握⼿过程；增加了⽹络延时（最⻓可以花费掉 2 RTT）
   -  握⼿后的对称加密报⽂传输。   


### 硬件优化   

  -  ⼀个好的 CPU，可以提⾼计算性能，因为 HTTPS 连接过程中就有⼤量需要计算密钥的过程，所以这样可以加速TLS 握⼿过程。

### 协议优化   

- 密钥交换算法优化：
     - 密钥交换算法应该选择 ECDHE 算法，⽽不⽤ RSA 算法，因为 ECDHE 算法具备前向安全性，⽽且客户端可以在第三次握⼿之后，就发送加密应⽤数据，节省了 1 RTT  

- TLS升级
     - 把 TLS 1.2 升级成 TLS 1.3，TLS 1.3 ⼤幅度简化了握⼿的步骤，完成 TLS 握⼿只要 1RTT，⽽且安全性更⾼。
     - TLS 1.3 把 Hello 和公钥交换这两个消息合并成了⼀个消息，于是这样就减少到只需 1 RTT 就能完成 TLS 握⼿。
     - TLS1.3 对于密钥交换算法，废除了不⽀持前向安全性的 RSA 和 DH 算法，只⽀持 ECDHE 算法  

### 证书优化  

- 证书传输优化
   - 对于服务器的证书应该选择椭圆曲线（ECDSA）证书，⽽不是 RSA 证书，因为在相同安全强度下， ECC 密钥⻓度⽐ RSA短的多。

- 证书验证优化
   - 服务器应该开启 OCSP Stapling 功能，由服务器预先获得 OCSP 的响应，并把响应结果缓存起来，这样 TLS握⼿的时候就不⽤再访问 CA 服务器，减少了⽹络通信的开销，提⾼了证书验证的效率  

>CRL 证书吊销列表（Certificate Revocation List），由 CA 定期更新，客户端收到服务器的证书后会下载此列表并遍历检验证书的合法性，但随着吊销证书的增多，列表会越来越⼤，下载的速度就会越慢    
>使用 OCSP 在线证书状态协议（Online Certificate Status Protocol）来查询证书的有效性，它是向 CA 发送查询请求，让 CA 返回证书的有效状态，不必像 CRL ⽅式客户端需要下载⼤⼤的列表   

> OCSP 需要向 CA 查询，因此也要发⽣⽹络请求，但如果⽹络状态不好，或者CA 服务器繁忙，也会导致客户端在校验证书这⼀环节的延时变⼤。

>OCSP Stapling，其原理是：**服务器**向 CA 周期性地查询证书状态，获得⼀个带有时间戳和签名的响应结果并缓存它，客户端发起连接请求时，服务器会「响应结果」在 TLS 握⼿过程中发给客户端。由于有签名的存在，服务器⽆法篡改，因此客户端就能得知证书是否已被吊销了，客户端就不需要再去查询     

### 会话复用
- Session ID
   - 客户端和服务器⾸次 TLS 握⼿连接后，双⽅会在内存缓存会话密钥，并⽤唯⼀的Session ID 来标识，Session ID 和会话密钥相当于 key-value 的关系。客户端再次连接时，hello 消息⾥会带上 Session ID，服务器收到后就会从内存找，找到了就直接用，跳过其他过程，当然为了安全性，内存中的会话密钥会定期失效     
      - 随着客户端的增多，服务器的内存压⼒也会越⼤。   

- Session Ticket  
   - 服务器不再缓存每个客户端的会话密钥，⽽是把缓存的⼯作交给了客户端，类似于 HTTP 的 Cookie  

   - 客户端与服务器⾸次建⽴连接时，服务器会加密「会话密钥」作为 Ticket 发给客户端，交给客户端缓存该 Ticket。客户端再次连接服务器时，客户端会发送 Ticket，服务器解密后就可以获取上次的会话密钥，然后验证有效期，如果没问题，就可以恢复会话了，开始加密通信。  

- Pre-shared Key

   -  Session ID 和 Session Ticket ⽅式都需要在 1 RTT 才能恢复会话。
   -  对于TLS1.3只需要 0 RTT，重连时，客户端会把 Ticket和 HTTP 请求⼀同发送给服务端，这种⽅式叫 Pre-shared Key